# Analysis Parameters for NK Cell Immunosenescence Study
# All hyperparameters and settings for downstream analysis

# Normalization parameters
normalization:
  # Method: log-normalization with library size correction
  method: "log_normalize"

  # Target sum for library size normalization (CPM scaling)
  target_sum: 10000

  # Apply log transformation: log(count + 1)
  log_transform: true

  # Apply z-score scaling after log transformation
  scale: true

  # Clip scaled values to prevent extreme outliers
  max_value: 10

  # Store raw counts in layer before normalization
  preserve_raw: true
  raw_layer_name: "counts"

# Highly Variable Gene (HVG) selection
feature_selection:
  # Number of HVGs to select
  n_top_genes: 2000

  # Method for HVG detection
  # Options: seurat, seurat_v3, cell_ranger
  flavor: "seurat_v3"

  # Perform batch-aware HVG selection
  batch_aware: true
  batch_key: "dataset_id"

  # Minimum number of batches a gene must be HVG in
  min_batches: 2

  # Force inclusion of specific marker genes
  force_include_markers: true

  # NK cell marker genes (always included)
  nk_marker_genes:
    - "NCAM1"
    - "FCGR3A"
    - "FCGR3B"
    - "NKG7"
    - "GNLY"
    - "KLRB1"
    - "KLRD1"
    - "KLRF1"
    - "KLRC1"
    - "NCR1"
    - "NCR3"
    - "PRF1"
    - "GZMB"
    - "GZMA"
    - "CD247"

  # Aging-related genes (always included)
  aging_marker_genes:
    - "CDKN1A"
    - "CDKN2A"
    - "CDKN2B"
    - "TP53"
    - "IL6"
    - "IL1B"
    - "CXCL8"
    - "TGFB1"
    - "HMGB1"
    - "S100A8"
    - "S100A9"
    - "SASP1"

# Dimensionality reduction
dimensionality_reduction:
  # PCA parameters
  pca:
    n_comps: 50
    zero_center: true
    svd_solver: "arpack"
    random_state: 42

  # UMAP parameters
  umap:
    min_dist: 0.3
    spread: 1.0
    n_neighbors: 15
    metric: "cosine"
    random_state: 42

# Batch correction / Integration methods
integration:
  # List of methods to compare
  methods:
    - "scvi"
    - "scanvi"
    - "harmony"

  # scVI parameters
  scvi:
    # Latent space dimensions
    n_latent: 30

    # Number of hidden layers in encoder/decoder
    n_layers: 2

    # Number of hidden units per layer
    n_hidden: 128

    # Dropout rate
    dropout_rate: 0.1

    # Gene likelihood model
    # Options: zinb (zero-inflated negative binomial), nb, poisson
    gene_likelihood: "nb"

    # Dispersion parameterization
    # Options: gene, gene-batch, gene-cell
    dispersion: "gene"

    # Training parameters
    max_epochs: 400
    early_stopping: true
    early_stopping_patience: 15
    early_stopping_monitor: "elbo_validation"
    train_size: 0.9
    validation_size: 0.1
    batch_size: 256  # Reduced for 8GB VRAM
    learning_rate: 0.001

    # Batch correction keys
    batch_key: "dataset_id"
    categorical_covariate_keys:
      - "sex"
      - "tissue"
      - "assay"
    continuous_covariate_keys:
      - "pct_counts_mt"
      - "total_counts"

    # Use GPU if available
    use_gpu: true

  # scANVI parameters (semi-supervised)
  scanvi:
    # Labels key (cell types)
    labels_key: "cell_type"

    # Unlabeled category name
    unlabeled_category: "Unknown"

    # Training parameters (initialized from scVI)
    max_epochs: 150
    early_stopping: true
    early_stopping_patience: 10
    train_size: 0.9
    batch_size: 256
    learning_rate: 0.001

    # Use GPU if available
    use_gpu: true

  # Harmony parameters
  harmony:
    # Batch key for correction
    batch_key: "dataset_id"

    # Maximum iterations
    max_iter_harmony: 10

    # Early stopping threshold
    early_stop: true

    # Clustering resolution for Harmony
    theta: 2

# Integration quality metrics
integration_metrics:
  # Calculate batch mixing metrics
  batch_metrics:
    - "ilisi"      # Integration LISI (higher is better)
    - "asw_batch"  # Average Silhouette Width for batch (lower is better)
    - "kbet"       # k-nearest neighbor batch effect test

  # Calculate biological conservation metrics
  bio_metrics:
    - "clisi"         # Cell type LISI (lower is better)
    - "asw_label"     # ASW for cell type (higher is better)
    - "nmi"           # Normalized Mutual Information
    - "ari"           # Adjusted Rand Index

  # Keys for metric calculation
  batch_key: "dataset_id"
  label_key: "cell_type"

  # Embedding to use for metrics
  embed: "X_scvi"  # Changes per method: X_scvi, X_scanvi, X_pca (for Harmony)

# Clustering (for visualization and QC)
clustering:
  # Method: Leiden algorithm (improved Louvain)
  method: "leiden"

  # Resolution parameter (higher = more clusters)
  resolution: 0.5

  # Random state for reproducibility
  random_state: 42

  # Number of neighbors for graph construction
  n_neighbors: 15

# Differential Expression Analysis
differential_expression:
  # Primary method: pseudobulk with DESeq2
  method: "pseudobulk_deseq2"

  # Pseudobulk aggregation parameters
  pseudobulk:
    # Group by donor and age group
    group_by:
      - "donor_id"
      - "age_group"

    # Minimum cells per pseudobulk sample
    min_cells: 10

    # Minimum samples per age group
    min_samples: 3

    # Aggregation method
    agg_method: "sum"  # Sum counts across cells

  # DESeq2 parameters
  deseq2:
    # Design formula (R-style)
    design_formula: "~ sex + dataset_id + age_group"

    # Reference level for age_group
    ref_level: "Young"

    # Alpha for multiple testing correction
    alpha: 0.05

    # Log fold change threshold
    lfc_threshold: 0.5

    # Independent filtering
    independent_filtering: true

    # Cook's cutoff
    cooks_cutoff: true

  # Comparisons to perform
  comparisons:
    - contrast: ["age_group", "Adult", "Young"]
      name: "Adult_vs_Young"

    - contrast: ["age_group", "Aged", "Young"]
      name: "Aged_vs_Young"

    - contrast: ["age_group", "Aged", "Adult"]
      name: "Aged_vs_Adult"

  # Multiple testing correction method
  # Options: fdr_bh (Benjamini-Hochberg), bonferroni
  correction_method: "fdr_bh"

  # Thresholds for significance
  significance:
    fdr: 0.05
    abs_log2fc: 0.5
    min_pct_expressed: 0.1  # Minimum fraction of cells expressing gene

# Gene Set Enrichment Analysis (GSEA)
gsea:
  # Enable GSEA
  enable: true

  # Gene set libraries to query
  libraries:
    - "KEGG_2021_Human"
    - "GO_Biological_Process_2021"
    - "GO_Molecular_Function_2021"
    - "Reactome_2022"
    - "WikiPathways_2021_Human"
    - "MSigDB_Hallmark_2020"

  # Organism
  organism: "human"

  # Statistical test
  # Options: fisher, hypergeometric
  method: "fisher"

  # Significance threshold
  alpha: 0.05

  # Minimum genes in pathway
  min_size: 5

  # Maximum genes in pathway
  max_size: 500

# Visualization parameters
visualization:
  # Default figure size (width, height in inches)
  figsize: [8, 6]

  # DPI for saved figures
  dpi: 300

  # File format for saved figures
  format: "pdf"

  # Color palettes
  palettes:
    age_group: ["#3498db", "#e74c3c", "#f39c12"]  # Blue, Red, Orange
    dataset: "tab20"
    cell_type: "Set2"

  # UMAP plot parameters
  umap_plot:
    point_size: 5
    alpha: 0.7
    legend_loc: "right margin"
    legend_fontsize: 10

  # Volcano plot parameters
  volcano:
    log2fc_threshold: 0.5
    pval_threshold: 0.05
    point_size: 3
    alpha: 0.6

  # Heatmap parameters
  heatmap:
    cmap: "RdBu_r"
    center: 0
    vmin: -2
    vmax: 2
    figsize: [10, 12]

# Reproducibility settings
reproducibility:
  # Random seed for all operations
  random_seed: 42

  # Set seeds for all libraries
  set_numpy_seed: true
  set_torch_seed: true
  set_python_seed: true

# Computational resources
compute:
  # Number of CPU cores to use
  n_jobs: -1  # -1 means use all available

  # GPU settings
  gpu:
    use_gpu: true
    gpu_id: 0

  # Memory management
  memory:
    # Maximum memory usage (GB) before warning
    max_memory_gb: 60

    # Enable garbage collection
    enable_gc: true

    # GC frequency
    gc_frequency: "per_step"

# Output settings
output:
  # Base directory for results
  results_dir: "results"

  # Subdirectories
  figures_dir: "results/figures"
  tables_dir: "results/tables"
  reports_dir: "results/reports"

  # Processed data directory
  processed_dir: "data/processed"

  # File naming convention
  filename_prefix: "nk_immunosenescence"

  # Timestamp format for files
  timestamp_format: "%Y%m%d_%H%M%S"

  # Save intermediate results
  save_intermediate: true

# Logging configuration
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"

  # Log file location
  log_file: "results/reports/pipeline.log"

  # Console output
  console_output: true

  # Include timestamps in log
  include_timestamp: true

  # Log format
  format: "[%(asctime)s] [%(levelname)s] %(message)s"
